# ZAP Pentest Report Analysis - ProjectOps

**Date:** 2026-01-10  
**Report:** 2026-01-10-ZAP-Report-.json  
**Scan Duration:** Full automated scan with authenticated session  
**Applicable To:** Both neutral brand (ProjectOps) and Deloitte-ProjectOps versions  
**Last Validation:** 2026-01-10 (manual code review)  
**Remediation Status:** ‚úÖ **v1.21.7 Released** - Critical fixes implemented

---

## Executive Summary

The ZAP scan identified **critical vulnerabilities** that require immediate attention. Additional manual review discovered further issues. Here's the prioritized breakdown:

- **URL allowlist policy:** External links are allowed, but only `http`/`https` schemes are permitted.

---

## üî¥ HIGH SEVERITY (Immediate Action Required)

### 1. Cross-Site Scripting (XSS) - Persistent (121 instances)

- **CWE-79** | WASC-8
- **Affected endpoints:** `/tasks/{id}` (view pages)
- **Vulnerable parameters:** `link_title`, `url`, `text`, `note`, `reason`, `name`, `title`, `description`
- **Attack vector:** `javascript:alert(1);` stored and rendered in task views
- **Root cause:** User-submitted content (comments, links, descriptions) is rendered without proper output encoding

### 2. Open Redirect (Manual Finding - Not in ZAP Report)

- **CWE-601** | WASC-38
- **Affected endpoints:**
  - `/auth/login` - `next` parameter (line 67)
  - `/auth/switch-tenant/<id>` - `next` parameter (line 133)
  - `/set-language/<lang>` - `request.referrer` (line 170)
- **Attack vector:** `https://app.example.com/auth/login?next=https://evil.com`
- **Root cause:** No validation that `next` URL is internal/relative

#### Root Cause Analysis (Verified in Codebase)

**1. Evidence Link URLs - CONFIRMED VULNERABLE:**

File: `routes/tasks.py` lines 744-746:
```python
# Basic URL validation - INSUFFICIENT!
if not url.startswith(('http://', 'https://')):
    url = 'https://' + url
```

This only prepends `https://` if missing, but **does NOT reject** `javascript:`, `data:`, `vbscript:` schemes!

**2. Template Rendering - CONFIRMED VULNERABLE:**

File: `templates/tasks/detail.html` lines 311-317:
```django-html
<a href="{{ ev.url }}" target="_blank" rel="noopener">
    {{ ev.link_title or ev.url }}
</a>
<div class="small text-muted">
    {{ ev.url }}
</div>
```

The `ev.url` is rendered in `href` attribute without scheme validation - allows `javascript:` execution on click.

**3. Template Escaping:**
- `{{ ev.link_title or ev.url }}` - Jinja2 auto-escapes by default ‚úì
- `href="{{ ev.url }}"` - No scheme validation ‚úó

### 2. SQL Injection (22 instances) - LIKELY FALSE POSITIVES

- **CWE-89** | WASC-19
- **Confidence:** LOW (ZAP reported low confidence)
- **Affected endpoints:**
  - `/admin/presets/{id}` - `category`, `is_recurring`, `default_owner_id`
  - `/admin/users/{id}/entities` - `access_level_*`, `inherit_*`
  - `/admin/tenants/{id}/members/add` - `role`
  - `/tasks/{id}/edit` - `year`, `entity_id`, `owner_id`, `title`
  - `/tasks/{id}/comments` - `text`
  - `/tasks/{id}/evidence/link` - `url`
  - `/tasks/new` - `entity_id`
  - `/projects/{id}/items` - `priority`, `assignee`

#### False Positive Analysis (Verified)

**Codebase uses SQLAlchemy ORM exclusively:**
- Searched for `db.session.execute`, `text()`, raw SQL - only found in `tests/conftest.py` (cleanup)
- All queries use parameterized ORM methods (`.filter()`, `.filter_by()`)
- No string concatenation in queries

**Why ZAP flagged these:**
1. Form validation errors change page content ‚Üí looks like injection success
2. Filter parameters affect result counts ‚Üí looks like boolean injection
3. Input echoed in error messages/flash ‚Üí looks like reflection

**Recommendation:** Mark as false positive after manual verification, document in accepted risks.

---

## üü† MEDIUM SEVERITY

### 3. Content Security Policy (CSP) Header Not Set

- **CWE-693** | Some HTML pages lack CSP
- **Impact:** Reduced mitigation against XSS attacks
- **Note:** CSP is implemented via nonce-based policy in `app.py`, but some responses may not include it (error pages, redirects)

### 4. Session ID in URL Rewrite (Socket.IO)

- **CWE-598** | `sid` parameter exposed in URLs for `/socket.io/`
- **Impact:** Session ID leakage via Referer headers, browser history, server logs
- **Decision:** Accept risk - this is the Socket.IO session ID (ephemeral), not the Flask session cookie

### 5. Sub Resource Integrity (SRI) Missing

- **CWE-345** | External scripts loaded without `integrity` attribute
- **Affected:** 
  - `https://cdn.jsdelivr.net/npm/marked/marked.min.js`
  - `https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js`
  - `https://cdn.socket.io/4.7.2/socket.io.min.js`
  - Bootstrap CSS/JS from jsdelivr
- **Impact:** CDN compromise could inject malicious code

---

## üü° LOW SEVERITY

### 6. Application Error Disclosure (500 errors)

- **CWE-550** | HTTP 500 errors expose debugging info
- **Affected:** `/notifications`, `/tasks`, `/tasks/archive`
- **Status:** Partially fixed in T1-T6, some regressions may exist
- **Root cause:** Missing tenant context, unhandled exceptions

### 7. Cross-Domain JavaScript Inclusion

- **CWE-829** | Third-party scripts from `cdn.jsdelivr.net`
- **Mitigation:** Add SRI hashes (covered in #5)

### 8. Server Version Leakage

- **CWE-497** | `Server: Werkzeug/3.1.5 Python/3.9.6` header exposed
- **Note:** `ServerHeaderMiddleware` implemented in `app.py` but may not cover all responses

### 9. X-Content-Type-Options Header Missing

- **CWE-693** | MIME-sniffing not disabled
- **Affected:** Some endpoints (Socket.IO, error pages)
- **Note:** Header set in `after_request` handler, verify coverage

---

## üìã DETAILED FIX PLAN

### Phase 1: Critical XSS Fixes (Immediate)

| Task | Issue | Fix Approach | File(s) | Lines |
|------|-------|--------------|---------|-------|
| **T13** | URL scheme injection | Allow external links but validate scheme; reject `javascript:`, `data:`, `vbscript:` | `routes/tasks.py` | 744-746 | ‚úÖ Fixed |
| **T14** | Template href safety | Use `url` only if it passes scheme validation, else render as text | `templates/tasks/detail.html` | 311-317 | ‚úÖ Fixed |
| **T15** | Audit all templates | Search for `href="{{ ` patterns with user data | All templates | ‚úÖ Audit Done (found T13/T14 issues) |
| **T16** | Server-side sanitization | HTML-escape text fields on input, not just output | `routes/tasks.py`, `services.py` | - |
| **T19** | Notification HTML escaping | Add `escapeHtml()` to notification `innerHTML` rendering | `templates/base.html` | 568-580, 630-645 | ‚úÖ Fixed |
| **T20** | Open Redirect | Validate `next` parameter is relative/internal URL | `routes/auth.py`, `routes/main.py` | 67, 133, 170 | ‚úÖ Fixed |

#### T20 Issue: Open Redirect Vulnerability (Manual Finding)

**Location:** 
- `routes/auth.py` line 67: `redirect(next_page or url_for('main.index'))`
- `routes/auth.py` line 133: `redirect(next_page or url_for('main.dashboard'))`
- `routes/main.py` line 170: `redirect(request.referrer or url_for('main.index'))`

**Problem:** No validation that `next`/`referrer` is a relative or internal URL.

**Attack Vector:** 
```
https://app.example.com/auth/login?next=https://evil.com/phishing
```
After login, user redirected to attacker's site.

**Fix:**
```python
from urllib.parse import urlparse

def is_safe_url(target):
    """Check if redirect target is safe (relative or same host)."""
    if not target:
        return False
    ref_url = urlparse(request.host_url)
    test_url = urlparse(urljoin(request.host_url, target))
    return test_url.scheme in ('http', 'https') and ref_url.netloc == test_url.netloc

# Usage:
next_page = request.args.get('next')
if next_page and not is_safe_url(next_page):
    next_page = None
return redirect(next_page or url_for('main.index'))
```

---

#### T19 Issue: Notification innerHTML Vulnerability

**Location:** `templates/base.html` lines 568-580 (createNotificationItem) and 630-645 (showNotificationToast)

**Problem:** Notifications render `title`, `message`, and `actor` fields directly via `innerHTML` without escaping:
```javascript
// VULNERABLE - line 577
<div class="notification-title ...">${notification.title}</div>
<div class="notification-message ...">${notification.message || ''}</div>
...${notification.actor + ' ‚Ä¢ ' : ''}...
```

**Risk Assessment:** üü† MEDIUM
- Notification titles contain `task.title` (user-controlled)
- `services.py` lines 822-893 include `task.title`, `reason`, `note` in notifications
- Jinja2 escapes on page render, but **not in JSON API responses** consumed by JS

**Fix:** Use `escapeHtml()` helper (already exists at line 1012):
```javascript
<div class="notification-title ...">${escapeHtml(notification.title)}</div>
<div class="notification-message ...">${escapeHtml(notification.message || '')}</div>
...${notification.actor ? escapeHtml(notification.actor) + ' ‚Ä¢ ' : ''}...
```

---

#### T13 Fix: URL Scheme Validation (External Allowed)

Replace in `routes/tasks.py` lines 744-746:

```python
# Current (vulnerable):
if not url.startswith(('http://', 'https://')):
    url = 'https://' + url

# Fixed:
from urllib.parse import urlparse

ALLOWED_URL_SCHEMES = ('http', 'https')  # Allow external links, block non-http(s) schemes

def validate_url(url):
    """Validate URL has allowed scheme, reject javascript:/data:/etc."""
    if not url:
        return None
    # Parse and validate scheme
    parsed = urlparse(url)
    if parsed.scheme.lower() not in ALLOWED_URL_SCHEMES:
        # Prepend https if no valid scheme
        if not parsed.scheme:
            url = 'https://' + url
            parsed = urlparse(url)
        else:
            # Reject dangerous schemes
            return None
    if parsed.scheme.lower() not in ALLOWED_URL_SCHEMES:
        return None
    return url

# In task_add_link():
url = validate_url(url)
if not url:
    flash('Ung√ºltige URL. Nur http:// und https:// erlaubt.', 'danger')
    return redirect(url_for('tasks.task_detail', task_id=task_id))
```

#### T14 Fix: Safe Template Rendering

Option A (Backend validation - preferred):
- With T13 fix, external URLs are allowed but restricted to http/https
- Template can render `href="{{ ev.url }}"` safely

Option B (Template defense-in-depth):
```django-html
{% if ev.url.startswith('http://') or ev.url.startswith('https://') %}
<a href="{{ ev.url }}" target="_blank" rel="noopener noreferrer">
{% else %}
<span class="text-danger" title="Invalid URL scheme">
{% endif %}
    {{ ev.link_title or ev.url }}
{% if ev.url.startswith('http://') or ev.url.startswith('https://') %}
</a>
{% else %}
</span>
{% endif %}
```

### Phase 2: Security Headers (This Week)

| Task | Issue | Fix Approach | File(s) |
|------|-------|--------------|---------|
| **T7** | CSP missing on some responses | Ensure `after_request` covers all responses including error pages | `app.py` |
| **T8** | Server header leak | Verify `ServerHeaderMiddleware` covers all paths | `app.py` |
| **T9** | SRI missing | Add `integrity` and `crossorigin` to all CDN scripts | `templates/base.html` |

#### T9: SRI Hashes to Generate

Generate with: `curl -s URL | openssl dgst -sha384 -binary | openssl base64 -A`

| Resource | SRI Hash (generate fresh) |
|----------|---------------------------|
| Bootstrap 5.3.2 CSS | `sha384-...` |
| Bootstrap 5.3.2 JS | `sha384-...` |
| Bootstrap Icons 1.11.1 | `sha384-...` |
| Chart.js 4.4.1 | `sha384-...` |
| Socket.IO 4.7.2 | `sha384-...` |
| marked.min.js | `sha384-...` |
| SortableJS | `sha384-...` |

### Phase 3: Verification & Hardening

| Task | Description |
|------|-------------|
| **T10** | Manually verify SQLi false positives (check SQLAlchemy logs) |
| **T11** | Document accepted risks (Socket.IO sid, HTML comments) |
| **T17** | Add DOMPurify for client-side markdown rendering | ‚úÖ Fixed |
| **T18** | Fix any remaining 500 errors |

---

## CSP Policy (Existing in app.py)

```python
# Current nonce-based CSP - verify this is applied to all responses
CSP_POLICY = (
    "default-src 'self'; "
    "script-src 'self' 'nonce-{nonce}' https://cdn.jsdelivr.net https://cdn.socket.io; "
    "style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; "
    "font-src 'self' https://cdn.jsdelivr.net; "
    "img-src 'self' data:; "
    "connect-src 'self' ws://localhost:* wss://localhost:* ws://127.0.0.1:* wss://127.0.0.1:*; "
    "frame-ancestors 'none'; "
    "form-action 'self';"
)
```

---

## Testing After Fixes

### 1. XSS Verification

| Test | Input | Expected Result |
|------|-------|-----------------|
| Evidence link - javascript: | `javascript:alert(1)` | Rejected with error message |
| Evidence link - data: | `data:text/html,<script>alert(1)</script>` | Rejected with error message |
| Evidence link - valid | `https://example.com` | Accepted, renders as link |
| Notification with XSS | Task title: `<script>alert(1)</script>` | Escaped, displays as text |

### 2. Open Redirect Verification

| Test | URL | Expected Result |
|------|-----|-----------------|
| External redirect | `/auth/login?next=https://evil.com` | Redirect to `/` (ignored) |
| Protocol-relative | `/auth/login?next=//evil.com` | Redirect to `/` (rejected) |
| Valid internal | `/auth/login?next=/dashboard` | Redirect to `/dashboard` (allowed) |

### 3. Re-run ZAP Scan

- Verify XSS alerts are gone
- Verify Open Redirect is not flagged
- Verify no new regressions

### 4. Functional Testing

- Add valid http/https links ‚Üí should work
- Login flow ‚Üí should redirect to dashboard
- Language switch ‚Üí should stay on same page
- CSP ‚Üí check browser console for errors

---

## References

- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [OWASP SQL Injection Prevention](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
- [OWASP Unvalidated Redirects](https://cheatsheetseries.owasp.org/cheatsheets/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html)
- [Content Security Policy Reference](https://content-security-policy.com/)
- [SRI Hash Generator](https://www.srihash.org/)

---

## Summary: Priority Order

1. **T13** - URL scheme validation (http/https only; external allowed) - ‚úÖ Fixed
2. **T14** - Template href safety (Defense in depth) - ‚úÖ Fixed
3. **T20** - Open Redirect validation - ‚úÖ Fixed
4. **T19** - Notification HTML escaping - ‚úÖ Fixed
5. **T9** - SRI attributes for CDN scripts - üü† This week
6. **T7/T8** - Security headers coverage - üü† This week
7. **T17** - DOMPurify for markdown - ‚úÖ Fixed
8. **T10** - Verify SQLi false positives - üü° Document (‚úÖ Verified FP)
9. **T11** - Document accepted risks - üü° Document

---

## Validation Summary (2026-01-10)

### ‚úÖ Verified Safe Patterns

| Pattern | Files | Status |
|---------|-------|--------|
| `href="{{ url_for(...) }}"` | 40+ instances | ‚úÖ SAFE - Flask url_for() |
| `{{ variable }}` (Jinja2) | All templates | ‚úÖ SAFE - Auto-escaping |
| `{{ var\|tojson\|safe }}` | methodology.html | ‚úÖ SAFE - JSON in script tags |
| `escapeHtml()` in search | base.html L984-1012 | ‚úÖ SAFE - Proper escaping |
| `data-bs-html="true"` popovers | 4 instances | ‚úÖ SAFE - Jinja2 escapes before attribute |
| `style="{{ ` patterns | 4 instances | ‚úÖ SAFE - Admin-controlled color values |
| `window.location` assignments | 6 instances | ‚úÖ SAFE - All use `url_for()` |
| `onclick` handlers with user data | 0 instances | ‚úÖ SAFE - None found |
| `document.write` / `eval` | 0 instances | ‚úÖ SAFE - None found |
| `src="{{ ` with user data | 0 instances | ‚úÖ SAFE - None found |

### üî¥ Confirmed Vulnerabilities

| Issue | Location | Risk | Fix Task |
|-------|----------|------|----------|
| Evidence link URL accepts `javascript:` | `routes/tasks.py` L744-746 | üî¥ Critical | ‚úÖ Fixed (T13) |
| Only `href="{{ ev.url }}"` with user data | `templates/tasks/detail.html` L311 | üî¥ Critical | ‚úÖ Fixed (T14) |
| Open Redirect - no `next` validation | `routes/auth.py` L67, L133; `main.py` L170 | üî¥ High | ‚úÖ Fixed (T20) |
| Notification innerHTML without escaping | `templates/base.html` L568-580, 630-645 | üü† Medium | ‚úÖ Fixed (T19) |
| Markdown rendering without DOMPurify | `projects/items/detail.html` L1012 | üü† Medium | ‚úÖ Fixed (T17) |

### ‚ö†Ô∏è Verified False Positives

| ZAP Finding | Evidence |
|-------------|----------|
| SQL Injection (22 instances) | Only `db.session.execute` in `tests/conftest.py` cleanup. All queries use SQLAlchemy ORM. |

### üìã Accepted Risks

| Finding | Reason |
|---------|--------|
| Socket.IO `sid` in URL | Ephemeral transport session, not Flask cookie |
| HTML comments (754) | Template documentation, no sensitive data |

---

## ‚úÖ Security Controls Verified (Manual Audit)

### Authentication & Session

| Control | Status | Evidence |
|---------|--------|----------|
| Password Hashing | ‚úÖ Secure | `pbkdf2:sha256` in `models.py` L450 |
| Login Rate Limiting | ‚úÖ Implemented | `@limiter.limit("10 per minute")` in `auth.py` L43 |
| Generic Login Error | ‚úÖ Secure | "Ung√ºltige Anmeldedaten" - no user enumeration |
| Session Cookies (Prod) | ‚úÖ Secure | `SESSION_COOKIE_SECURE=True, HTTPONLY=True, SAMESITE=Lax` |
| CSRF Protection | ‚úÖ Enabled | `csrf.init_app(app)` in `app.py` |

### Authorization

| Control | Status | Evidence |
|---------|--------|----------|
| Tenant Scoping | ‚úÖ Enforced | `get_task_or_404_scoped()` in `middleware/tenant.py` |
| API Auth | ‚úÖ All protected | `@login_required` on all `/api/*` routes |
| Admin Routes | ‚úÖ Protected | `@superadmin_required` decorator |
| IDOR Prevention | ‚úÖ Tenant-scoped | All lookups filter by `tenant_id` |

### Data Protection

| Control | Status | Evidence |
|---------|--------|----------|
| API Key Storage | ‚úÖ Hashed | SHA256 hash only, prefix for display |
| File Upload | ‚úÖ Restricted | `secure_filename()` + extension whitelist |
| File Type Validation | ‚úÖ Whitelist | `ALLOWED_EXTENSIONS` in `config.py` |
| Secrets from Env | ‚úÖ Required | `SECRET_KEY` from env, fails in prod if missing |
| No Sensitive Logging | ‚úÖ Verified | No password/key logging found |

### Security Headers

| Control | Status | Evidence |
|---------|--------|----------|
| CSP | ‚úÖ Nonce-based | `generate_csp_nonce()` in `app.py` |
| CORS (Socket.IO) | ‚úÖ Restricted | Same-origin in prod, `*` only in debug |
| X-Content-Type | ‚ö†Ô∏è Partial | Set in after_request, verify coverage |
| Server Header | ‚ö†Ô∏è Partial | `ServerHeaderMiddleware` exists, verify coverage |

### Input Validation

| Control | Status | Evidence |
|---------|--------|----------|
| Form CSRF | ‚úÖ Enabled | Flask-WTF CSRF protection |
| Max Upload Size | ‚úÖ 16MB | `MAX_CONTENT_LENGTH` in `config.py` |
| Path Traversal | ‚úÖ Protected | `secure_filename()` + UUID prefix |
| Command Injection | ‚úÖ N/A | No `subprocess`/`os.system` in web app |
