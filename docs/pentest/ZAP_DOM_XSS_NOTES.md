# ZAP Penetration Test - Remediation Tracking

> Quick reference for ZAP findings and remediation status.
> 
> **Last Updated:** 2026-01-10  
> **Remediation Status:** âœ… **v1.21.7 Released** - Critical fixes implemented  
> **Detailed Fix Plan:** See [`2026-01-10-ZAP-FIX-PLAN.md`](2026-01-10-ZAP-FIX-PLAN.md) for code-level fixes.
> **ZAP Report:** `2026-01-10-ZAP-Report-.json`

---

## Executive Summary

- **URL allowlist policy:** External links are allowed, but only `http`/`https` schemes are permitted.

| Severity | Finding | Count | Status |
|----------|---------|-------|--------|
| **ğŸ”´ HIGH** | Persistent XSS (Stored) | 121 | âœ… Fixed (T13/T14) |
| **ğŸ”´ HIGH** | Open Redirect | 3 | âœ… Fixed (T20) |
| **ğŸ”´ HIGH** | SQL Injection | 22 | âœ… FALSE POSITIVE (verified) |
| **ğŸŸ  MEDIUM** | CSP Header Not Set | 5 | â³ T7 |
| **ğŸŸ  MEDIUM** | Session ID in URL (Socket.IO) | 5 | âœ… Accept risk |
| **ğŸŸ  MEDIUM** | SRI Missing (CDN scripts) | 5 | âœ… Partial (T17 - DOMPurify) |
| **ğŸŸ¡ LOW** | Application Error Disclosure (500s) | 6 | âœ… Fixed (T1-T6) |
| **ğŸŸ¡ LOW** | Server Header Leak | 1 | â³ T8 |
| **â„¹ï¸ INFO** | HTML Comments | 754 | âœ… Accept |

---

## âœ… Fixes Implemented (v1.21.7)

| Task | Fix | File |
|------|-----|------|
| T13 | `validate_external_url()` - allow only http/https | `routes/tasks.py` |
| T14 | Defense-in-depth template check | `templates/tasks/detail.html` |
| T17 | DOMPurify + SRI for markdown | `modules/projects/.../detail.html` |
| T19 | `escapeHtml()` for notifications | `templates/base.html` |
| T20 | `is_safe_redirect()` for redirects | `routes/auth.py`, `routes/main.py` |

---

## XSS Vulnerability (Fixed)
- `routes/tasks.py` line 744-746: URL scheme validation only prepends `https://`, doesn't reject `javascript:`
- `templates/tasks/detail.html` line 311: `href="{{ ev.url }}"` renders dangerous URLs

**Attack Vector:** User adds evidence link with `javascript:alert(1)` â†’ stored in DB â†’ rendered as clickable link

**Fix Required:** See [2026-01-10-ZAP-FIX-PLAN.md](2026-01-10-ZAP-FIX-PLAN.md) Task T13/T14 (external links allowed, http/https only)

---

## Remediation Task Tracker

### Completed (T1-T6)

| Task | Description | Status |
|------|-------------|--------|
| T1 | Fix `/notifications` 500 | âœ… Done |
| T2 | Fix `/tasks/archive` 500 | âœ… Done |
| T3 | Fix `/tasks/<id>/status` + archive 500 | âœ… Done |
| T4 | Fix `/admin/tenants/<id>/export-excel` 500 | âœ… Done |
| T5 | Fix `/projects/<id>/settings/statuses` 500 | âœ… Done |
| T6 | Fix filtered `/tasks?...` 500 | âœ… Done |

### Critical Priority (Do First)

| Task | Description | Priority | Status |
|------|-------------|----------|--------|
| **T13** | URL scheme validation in `routes/tasks.py` | ğŸ”´ Critical | âœ… Fixed |
| **T14** | Template href safety in `templates/tasks/detail.html` | ğŸ”´ Critical | âœ… Fixed |
| **T20** | Open Redirect validation in `routes/auth.py` | ğŸ”´ High | âœ… Fixed |

### High Priority

| Task | Description | Priority | Status |
|------|-------------|----------|--------|
| **T19** | Notification HTML escaping in `base.html` | ğŸŸ  High | âœ… Fixed |
| T7 | CSP coverage (ensure all responses) | ğŸŸ  High | â³ Pending |
| T8 | Server header leak coverage | ğŸŸ  High | â³ Pending |
| T9 | Add SRI to CDN scripts | ğŸŸ  High | â³ Pending |
| T17 | Add DOMPurify for markdown | ğŸŸ  High | âœ… Fixed |

### Medium/Low Priority

| Task | Description | Priority | Status |
|------|-------------|----------|--------|
| T10 | Document SQLi as false positive | ğŸŸ¡ Medium | âœ… Verified FP |
| T11 | Document accepted risks | ğŸŸ¡ Low | â³ Pending |
| T15 | Audit all template escaping | ğŸŸ¡ Medium | âœ… Audit done (found issues â†’ T13/T14) |
| T16 | Server-side text sanitization | ğŸŸ¡ Medium | â³ Pending |
| T18 | Fix remaining 500 errors | ğŸŸ¡ Low | â³ Pending |

---

## DOM XSS Risk Areas

### 1. Notification System (`templates/base.html`) - ğŸŸ  T19

Uses `innerHTML` for notification rendering at lines 568-580 and 630-645.

**Problem:** `notification.title`, `notification.message`, `notification.actor` rendered without escaping.

**Data Source:** Notifications include user-controlled `task.title`, `reason`, `note` from `services.py`.

**Risk:** ğŸŸ  MEDIUM - User-controlled task titles flow through API JSON â†’ JS innerHTML.

**Fix:** T19 - Add `escapeHtml()` to all notification template strings. Helper already exists at line 1012.

### 2. Markdown Rendering (`projects/items/detail.html`) - ğŸŸ  T17

Uses `marked.js` at line 1012 without DOMPurify:
```javascript
targetEl.innerHTML = marked.parse(markdown);
```

**Risk:** ğŸŸ  MEDIUM - User markdown could contain malicious HTML.

**Fix:** T17 - Add DOMPurify sanitization.

### 3. Search Results - âœ… SAFE

Uses `innerHTML` with `escapeHtml()` helper at lines 984-1006.

**Risk:** âœ… LOW - Proper escaping implemented.

### 4. Bootstrap Popovers - âœ… SAFE

4 instances of `data-bs-html="true"` in calendar/task templates.

**Analysis:** Jinja2 auto-escapes content before placing in data attributes. Tested:
- `<script>` â†’ `&lt;script&gt;` (safe)
- `' onclick='` â†’ `&#39; onclick=&#39;` (safe)

**Risk:** âœ… SAFE - Jinja2 escaping prevents breakout.

---

## Accepted Risks

| Finding | Reason |
|---------|--------|
| Socket.IO `sid` in URL | Ephemeral transport session, not Flask cookie |
| HTML comments (754) | Template documentation, no sensitive data |
| SQLi alerts (22) | FALSE POSITIVE - verified SQLAlchemy ORM usage, no raw SQL |

---

## Files Reference

- [2026-01-10-ZAP-FIX-PLAN.md](2026-01-10-ZAP-FIX-PLAN.md) - Detailed fix implementations
- [2026-01-10-ZAP-Report-.json](2026-01-10-ZAP-Report-.json) - Full ZAP scan results
- [evidence-T7-csp-nonce.txt](evidence-T7-csp-nonce.txt) - CSP nonce investigation

---

*Last updated: 2026-01-10*
