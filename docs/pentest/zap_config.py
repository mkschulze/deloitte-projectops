#!/usr/bin/env python3
"""
OWASP ZAP Configuration Script for Deloitte ProjectOps
======================================================

This script configures ZAP for authenticated scanning of the Flask application.

Prerequisites:
    1. Start ZAP with API enabled:
       /Applications/OWASP\ ZAP.app/Contents/Java/zap.sh -daemon -port 8080 -config api.key=projectops2026
       
       Or on macOS with GUI:
       Open ZAP ‚Üí Tools ‚Üí Options ‚Üí API ‚Üí Generate API Key ‚Üí Copy key
       
    2. Install python-owasp-zap-v2.4:
       pip install python-owasp-zap-v2.4

Usage:
    python zap_config.py [--api-key YOUR_API_KEY] [--target http://127.0.0.1:5000]
    
Author: Security Team
Date: 2026-01-04
"""

import time
import argparse
from zapv2 import ZAPv2

# =============================================================================
# CONFIGURATION
# =============================================================================

DEFAULT_TARGET = 'http://127.0.0.1:5000'
DEFAULT_ZAP_PROXY = 'http://127.0.0.1:8080'
DEFAULT_API_KEY = 'projectops2026'  # Change this to your ZAP API key

# Login credentials (pentest user - exempt from rate limiting)
LOGIN_URL = '/login'
LOGIN_USER = 'pentest@zap.local'
LOGIN_PASS = 'ZapTest2026!'

# Authentication indicators
LOGGED_IN_INDICATOR = r'\QDashboard\E|logout|Abmelden|Willkommen'
LOGGED_OUT_INDICATOR = r'\QAnmelden\E|login|Sign in|Bitte melden'

# URLs to exclude from scanning (static assets, external)
EXCLUDE_URLS = [
    r'.*\.css$',
    r'.*\.js$',
    r'.*\.png$',
    r'.*\.jpg$',
    r'.*\.gif$',
    r'.*\.ico$',
    r'.*\.woff2?$',
    r'.*cdn\.jsdelivr\.net.*',
    r'.*cdn\.socket\.io.*',
]

# URLs to include in scan context
INCLUDE_URLS = [
    r'http://127\.0\.0\.1:5000.*',
]


# =============================================================================
# ZAP CONFIGURATION CLASS
# =============================================================================

class ZAPConfigurator:
    """Configure OWASP ZAP for ProjectOps scanning."""
    
    def __init__(self, target: str, api_key: str, zap_proxy: str = DEFAULT_ZAP_PROXY):
        self.target = target
        self.api_key = api_key
        self.zap_proxy = zap_proxy
        self.context_name = 'ProjectOps'
        self.context_id = None
        self.user_id = None
        
        # Initialize ZAP API client
        self.zap = ZAPv2(
            apikey=api_key,
            proxies={'http': zap_proxy, 'https': zap_proxy}
        )
        
    def check_connection(self) -> bool:
        """Check if ZAP is running and accessible."""
        try:
            version = self.zap.core.version
            print(f"‚úÖ Connected to ZAP version: {version}")
            return True
        except Exception as e:
            print(f"‚ùå Cannot connect to ZAP at {self.zap_proxy}")
            print(f"   Error: {e}")
            print("\n   Make sure ZAP is running with API enabled:")
            print("   zap.sh -daemon -port 8080 -config api.key=projectops2026")
            return False
    
    def create_context(self) -> str:
        """Create a new context for the target application."""
        print(f"\nüìÅ Creating context: {self.context_name}")
        
        # Remove existing context if exists
        contexts = self.zap.context.context_list
        if self.context_name in contexts:
            print(f"   Removing existing context...")
            self.zap.context.remove_context(self.context_name)
        
        # Create new context
        self.context_id = self.zap.context.new_context(self.context_name)
        print(f"   Context ID: {self.context_id}")
        
        # Include target URLs
        for pattern in INCLUDE_URLS:
            self.zap.context.include_in_context(self.context_name, pattern)
            print(f"   ‚úÖ Included: {pattern}")
        
        # Exclude static assets
        for pattern in EXCLUDE_URLS:
            self.zap.context.exclude_from_context(self.context_name, pattern)
            print(f"   ‚õî Excluded: {pattern}")
        
        return self.context_id
    
    def configure_authentication(self):
        """Configure form-based authentication."""
        print(f"\nüîê Configuring authentication...")
        
        # Set form-based authentication
        login_url = f"{self.target}{LOGIN_URL}"
        login_request_data = f"csrf_token={{%csrf_token%}}&email={{%username%}}&password={{%password%}}&remember=on"
        
        auth_method_config = (
            f"loginUrl={login_url}&"
            f"loginRequestData={login_request_data}"
        )
        
        self.zap.authentication.set_authentication_method(
            contextid=self.context_id,
            authmethodname='formBasedAuthentication',
            authmethodconfigparams=auth_method_config
        )
        print(f"   ‚úÖ Form-based auth configured for {login_url}")
        
        # Set logged in/out indicators
        self.zap.authentication.set_logged_in_indicator(
            contextid=self.context_id,
            loggedinindicatorregex=LOGGED_IN_INDICATOR
        )
        print(f"   ‚úÖ Logged-in indicator: {LOGGED_IN_INDICATOR}")
        
        self.zap.authentication.set_logged_out_indicator(
            contextid=self.context_id,
            loggedoutindicatorregex=LOGGED_OUT_INDICATOR
        )
        print(f"   ‚úÖ Logged-out indicator: {LOGGED_OUT_INDICATOR}")
    
    def configure_session_management(self):
        """Configure cookie-based session management."""
        print(f"\nüç™ Configuring session management...")
        
        self.zap.sessionManagement.set_session_management_method(
            contextid=self.context_id,
            methodname='cookieBasedSessionManagement',
            methodconfigparams=''
        )
        print(f"   ‚úÖ Cookie-based session management enabled")
    
    def create_user(self) -> str:
        """Create a user for authenticated scanning."""
        print(f"\nüë§ Creating scan user...")
        
        # Create user
        self.user_id = self.zap.users.new_user(
            contextid=self.context_id,
            name='PentestUser'
        )
        print(f"   User ID: {self.user_id}")
        
        # Set credentials
        auth_credentials = f"username={LOGIN_USER}&password={LOGIN_PASS}"
        self.zap.users.set_authentication_credentials(
            contextid=self.context_id,
            userid=self.user_id,
            authcredentialsconfigparams=auth_credentials
        )
        print(f"   ‚úÖ Credentials set for {LOGIN_USER}")
        
        # Enable user
        self.zap.users.set_user_enabled(
            contextid=self.context_id,
            userid=self.user_id,
            enabled=True
        )
        print(f"   ‚úÖ User enabled")
        
        return self.user_id
    
    def configure_anti_csrf(self):
        """Configure anti-CSRF token handling."""
        print(f"\nüõ°Ô∏è Configuring anti-CSRF tokens...")
        
        # Add csrf_token as anti-CSRF token name
        tokens = self.zap.acsrf.option_tokens_names
        if 'csrf_token' not in tokens:
            self.zap.acsrf.add_option_token('csrf_token')
            print(f"   ‚úÖ Added 'csrf_token' to anti-CSRF tokens")
        else:
            print(f"   ‚ÑπÔ∏è 'csrf_token' already configured")
    
    def configure_scan_policy(self):
        """Configure active scan policy."""
        print(f"\n‚öôÔ∏è Configuring scan policy...")
        
        policy_name = 'ProjectOps-Policy'
        
        # Create or update policy
        try:
            self.zap.ascan.remove_scan_policy(policy_name)
        except:
            pass
        
        self.zap.ascan.add_scan_policy(policy_name)
        print(f"   ‚úÖ Scan policy created: {policy_name}")
        
        # Enable all scanners but with sensible thresholds
        # (You can customize which scanners to enable/disable)
        
        return policy_name
    
    def access_target(self):
        """Access target to seed the site tree."""
        print(f"\nüåê Accessing target: {self.target}")
        
        self.zap.core.access_url(self.target)
        time.sleep(2)
        print(f"   ‚úÖ Target accessed")
    
    def run_spider(self, as_user: bool = True):
        """Run the spider to discover URLs."""
        print(f"\nüï∑Ô∏è Starting spider...")
        
        if as_user and self.user_id:
            scan_id = self.zap.spider.scan_as_user(
                contextid=self.context_id,
                userid=self.user_id,
                url=self.target,
                maxchildren=None,
                recurse=True,
                subtreeonly=False
            )
            print(f"   Running as authenticated user...")
        else:
            scan_id = self.zap.spider.scan(self.target)
        
        print(f"   Spider scan ID: {scan_id}")
        
        # Wait for spider to complete
        while int(self.zap.spider.status(scan_id)) < 100:
            progress = self.zap.spider.status(scan_id)
            print(f"   Progress: {progress}%", end='\r')
            time.sleep(1)
        
        print(f"\n   ‚úÖ Spider complete! Found {len(self.zap.spider.results(scan_id))} URLs")
        
        return scan_id
    
    def run_ajax_spider(self, as_user: bool = True):
        """Run Ajax Spider for JavaScript-heavy pages."""
        print(f"\nüï∏Ô∏è Starting Ajax Spider...")
        
        if as_user and self.user_id:
            self.zap.ajaxSpider.scan_as_user(
                contextname=self.context_name,
                username='PentestUser',
                url=self.target
            )
        else:
            self.zap.ajaxSpider.scan(self.target)
        
        # Wait for Ajax spider
        while self.zap.ajaxSpider.status == 'running':
            print(f"   Status: {self.zap.ajaxSpider.status}", end='\r')
            time.sleep(2)
        
        results = self.zap.ajaxSpider.number_of_results
        print(f"\n   ‚úÖ Ajax Spider complete! Found {results} additional URLs")
    
    def run_active_scan(self, as_user: bool = True):
        """Run active security scan."""
        print(f"\nüîç Starting active scan...")
        
        if as_user and self.user_id:
            scan_id = self.zap.ascan.scan_as_user(
                url=self.target,
                contextid=self.context_id,
                userid=self.user_id,
                recurse=True
            )
        else:
            scan_id = self.zap.ascan.scan(self.target)
        
        print(f"   Active scan ID: {scan_id}")
        
        # Wait for scan to complete
        while int(self.zap.ascan.status(scan_id)) < 100:
            progress = self.zap.ascan.status(scan_id)
            print(f"   Progress: {progress}%", end='\r')
            time.sleep(5)
        
        print(f"\n   ‚úÖ Active scan complete!")
        
        return scan_id
    
    def get_alerts(self) -> list:
        """Get all alerts from the scan."""
        alerts = self.zap.core.alerts(baseurl=self.target)
        return alerts
    
    def generate_report(self, output_file: str = 'zap_report.html'):
        """Generate HTML report."""
        print(f"\nüìä Generating report: {output_file}")
        
        report = self.zap.core.htmlreport()
        with open(output_file, 'w') as f:
            f.write(report)
        
        print(f"   ‚úÖ Report saved to {output_file}")
        
        # Also generate JSON report
        json_file = output_file.replace('.html', '.json')
        json_report = self.zap.core.jsonreport()
        with open(json_file, 'w') as f:
            f.write(json_report)
        
        print(f"   ‚úÖ JSON report saved to {json_file}")
    
    def print_summary(self):
        """Print scan summary."""
        alerts = self.get_alerts()
        
        # Count by risk level
        high = len([a for a in alerts if a['risk'] == 'High'])
        medium = len([a for a in alerts if a['risk'] == 'Medium'])
        low = len([a for a in alerts if a['risk'] == 'Low'])
        info = len([a for a in alerts if a['risk'] == 'Informational'])
        
        print("\n" + "=" * 60)
        print("üìã SCAN SUMMARY")
        print("=" * 60)
        print(f"   üî¥ High Risk:     {high}")
        print(f"   üü† Medium Risk:   {medium}")
        print(f"   üü° Low Risk:      {low}")
        print(f"   üîµ Informational: {info}")
        print("=" * 60)
        
        if high > 0:
            print("\n‚ö†Ô∏è HIGH RISK FINDINGS:")
            for alert in [a for a in alerts if a['risk'] == 'High']:
                print(f"   ‚Ä¢ {alert['alert']}")
                print(f"     URL: {alert['url']}")
    
    def configure_all(self):
        """Run complete configuration."""
        print("=" * 60)
        print("üîß OWASP ZAP CONFIGURATION FOR PROJECTOPS")
        print("=" * 60)
        
        if not self.check_connection():
            return False
        
        self.create_context()
        self.configure_authentication()
        self.configure_session_management()
        self.create_user()
        self.configure_anti_csrf()
        self.configure_scan_policy()
        
        print("\n" + "=" * 60)
        print("‚úÖ CONFIGURATION COMPLETE!")
        print("=" * 60)
        print(f"\nContext: {self.context_name} (ID: {self.context_id})")
        print(f"User: PentestUser (ID: {self.user_id})")
        print(f"Target: {self.target}")
        print("\nNext steps:")
        print("  1. In ZAP GUI: Enable 'Forced User Mode' (toolbar icon)")
        print("  2. Select 'PentestUser' as the forced user")
        print("  3. Run Spider or Active Scan from the GUI")
        print("\nOr run full scan with: python zap_config.py --full-scan")
        
        return True
    
    def run_full_scan(self):
        """Run complete scan workflow."""
        if not self.configure_all():
            return
        
        print("\n" + "=" * 60)
        print("üöÄ STARTING FULL SCAN")
        print("=" * 60)
        
        self.access_target()
        self.run_spider(as_user=True)
        
        # Optional: Run Ajax Spider for JS content
        # self.run_ajax_spider(as_user=True)
        
        self.run_active_scan(as_user=True)
        self.print_summary()
        self.generate_report('admin/PENTEST/zap_full_report.html')


# =============================================================================
# MAIN
# =============================================================================

def main():
    parser = argparse.ArgumentParser(
        description='Configure OWASP ZAP for ProjectOps scanning'
    )
    parser.add_argument(
        '--api-key', '-k',
        default=DEFAULT_API_KEY,
        help=f'ZAP API key (default: {DEFAULT_API_KEY})'
    )
    parser.add_argument(
        '--target', '-t',
        default=DEFAULT_TARGET,
        help=f'Target URL (default: {DEFAULT_TARGET})'
    )
    parser.add_argument(
        '--zap-proxy', '-p',
        default=DEFAULT_ZAP_PROXY,
        help=f'ZAP proxy URL (default: {DEFAULT_ZAP_PROXY})'
    )
    parser.add_argument(
        '--full-scan', '-f',
        action='store_true',
        help='Run full scan after configuration'
    )
    parser.add_argument(
        '--spider-only', '-s',
        action='store_true',
        help='Configure and run spider only (no active scan)'
    )
    
    args = parser.parse_args()
    
    configurator = ZAPConfigurator(
        target=args.target,
        api_key=args.api_key,
        zap_proxy=args.zap_proxy
    )
    
    if args.full_scan:
        configurator.run_full_scan()
    elif args.spider_only:
        if configurator.configure_all():
            configurator.access_target()
            configurator.run_spider(as_user=True)
            configurator.print_summary()
    else:
        configurator.configure_all()


if __name__ == '__main__':
    main()
