{% extends "base.html" %}

{% block title %}Sprint Board - {{ sprint.name }} - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
    .sprint-header-bar {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem 0;
        margin-bottom: 1rem;
    }
    
    .sprint-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }
    
    .sprint-badge {
        padding: 0.35rem 0.85rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .sprint-badge.active { background: #86bc25; color: white; }
    .sprint-badge.future { background: #e3f2fd; color: #1565c0; }
    .sprint-badge.closed { background: #6c757d; color: white; }
    
    .sprint-progress-mini {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .sprint-progress-bar-mini {
        width: 150px;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .sprint-progress-fill {
        height: 100%;
        background: #86bc25;
        transition: width 0.3s;
    }
    
    .board-container {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 1rem;
        min-height: calc(100vh - 300px);
    }
    
    .board-column {
        min-width: 280px;
        max-width: 280px;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    
    .board-column-header {
        padding: 0.75rem 1rem;
        font-weight: 600;
        border-bottom: 3px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
    }
    
    .board-column-header .issue-count {
        background: rgba(0,0,0,0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.875rem;
    }
    
    .board-column-body {
        flex: 1;
        padding: 0.5rem;
        overflow-y: auto;
        min-height: 150px;
    }
    
    .issue-card {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: grab;
        transition: box-shadow 0.2s, transform 0.2s;
        position: relative;
        padding-left: 1rem;
    }
    
    .issue-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .issue-card.sortable-ghost { opacity: 0.4; }
    .issue-card.sortable-chosen { transform: rotate(3deg); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    
    .issue-card-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .issue-card-key {
        font-size: 0.8rem;
        color: #666;
    }
    
    .issue-card-summary {
        font-weight: 500;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .issue-card-summary a {
        color: inherit;
        text-decoration: none;
    }
    
    .issue-card-summary a:hover {
        color: #86bc25;
    }
    
    .issue-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: #666;
    }
    
    .issue-card-assignee-initials {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #86bc25;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .status-todo { border-color: #6c757d !important; }
    .status-in_progress { border-color: #0d6efd !important; }
    .status-done { border-color: #198754 !important; }
    
    .priority-indicator {
        width: 4px;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        border-radius: 6px 0 0 6px;
    }
    
    .priority-critical { background: #dc3545; }
    .priority-high { background: #fd7e14; }
    .priority-medium { background: #ffc107; }
    .priority-low { background: #20c997; }
    
    .empty-column-placeholder {
        padding: 2rem 1rem;
        text-align: center;
        color: #999;
        border: 2px dashed #ddd;
        border-radius: 6px;
        margin: 0.5rem;
    }
    
    .goal-text {
        color: #666;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
{% set total_points = sprint.total_points %}
{% set completed_points = sprint.completed_points %}
{% set progress = (completed_points / total_points * 100) if total_points > 0 else 0 %}
{% set total_issues = sprint.issues|length %}
{% set completed_issues = sprint.issues|selectattr('status.is_final')|list|length %}

<div class="container-fluid py-4">
    <!-- Sprint Header -->
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{{ url_for('projects.project_list') }}">{{ 'Projekte' if lang == 'de' else 'Projects' }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('projects.project_detail', project_id=project.id) }}">{{ project.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('projects.sprint_list', project_id=project.id) }}">Sprints</a></li>
                    <li class="breadcrumb-item active">{{ sprint.name }}</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="bi bi-kanban me-2"></i>
                {{ sprint.name }}
                <span class="sprint-badge {{ sprint.state }}">
                    {{ {'future': 'Geplant' if lang == 'de' else 'Planned', 'active': 'Aktiv' if lang == 'de' else 'Active', 'closed': 'Abgeschlossen' if lang == 'de' else 'Closed'}[sprint.state] }}
                </span>
            </h1>
            {% if sprint.goal %}
            <p class="goal-text mt-2 mb-0">
                <i class="bi bi-flag me-1"></i>{{ sprint.goal }}
            </p>
            {% endif %}
        </div>
        <div class="d-flex gap-2 align-items-center">
            <div class="sprint-progress-mini">
                <div class="sprint-progress-bar-mini">
                    <div class="sprint-progress-fill" style="width: {{ progress }}%"></div>
                </div>
                <span class="text-muted small">{{ completed_points }}/{{ total_points }} SP</span>
            </div>
            <a href="{{ url_for('projects.sprint_edit', project_id=project.id, sprint_id=sprint.id) }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-pencil"></i>
            </a>
            <a href="{{ url_for('projects.sprint_list', project_id=project.id) }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>{{ 'Zurück' if lang == 'de' else 'Back' }}
            </a>
        </div>
    </div>
    
    <!-- Sprint Stats -->
    <div class="row mb-4">
        <div class="col-auto">
            <div class="d-flex align-items-center gap-3 text-muted small">
                {% if sprint.start_date %}
                <span><i class="bi bi-calendar-event me-1"></i>{{ sprint.start_date.strftime('%d.%m.%Y') }}</span>
                {% endif %}
                {% if sprint.end_date %}
                <span><i class="bi bi-calendar-check me-1"></i>{{ sprint.end_date.strftime('%d.%m.%Y') }}</span>
                {% endif %}
                <span><i class="bi bi-list-task me-1"></i>{{ completed_issues }}/{{ total_issues }} Issues</span>
                <span><i class="bi bi-lightning me-1"></i>{{ progress|int }}% {{ 'abgeschlossen' if lang == 'de' else 'complete' }}</span>
            </div>
        </div>
    </div>
    
    <!-- Board -->
    <div class="board-container">
        {% for status in statuses %}
            {% set status_issues = issues_by_status.get(status.id, []) %}
            {% set status_class = 'status-' + status.category if status.category else '' %}
            
            <div class="board-column" data-status-id="{{ status.id }}">
                <div class="board-column-header {{ status_class }}" style="{% if status.color %}border-color: {{ status.color }};{% endif %}">
                    <span>
                        {% if status.icon %}<i class="bi bi-{{ status.icon }} me-1"></i>{% endif %}
                        {{ status.get_name(lang) }}
                    </span>
                    <span class="issue-count">{{ status_issues|length }}</span>
                </div>
                
                <div class="board-column-body sortable-column" data-status-id="{{ status.id }}">
                    {% if status_issues %}
                        {% for issue in status_issues %}
                            <div class="issue-card" data-issue-id="{{ issue.id }}" data-issue-key="{{ issue.key }}">
                                <div class="priority-indicator priority-{% if issue.priority == 1 %}critical{% elif issue.priority == 2 %}high{% elif issue.priority == 3 %}medium{% else %}low{% endif %}"></div>
                                
                                <div class="issue-card-header">
                                    <span style="color: {{ issue.type.color or '#666' }}">
                                        <i class="bi bi-{{ issue.type.icon or 'circle' }}"></i>
                                    </span>
                                    <span class="issue-card-key">{{ issue.key }}</span>
                                    {% if issue.story_points %}
                                    <span class="badge bg-light text-dark ms-auto" title="Story Points">{{ issue.story_points }}</span>
                                    {% endif %}
                                </div>
                                
                                <div class="issue-card-summary">
                                    <a href="{{ url_for('projects.issue_detail', project_id=project.id, issue_key=issue.key) }}">
                                        {{ issue.summary }}
                                    </a>
                                </div>
                                
                                <div class="issue-card-footer">
                                    <div class="d-flex align-items-center gap-2">
                                        {% if issue.assignee %}
                                            <span class="issue-card-assignee-initials" title="{{ issue.assignee.username }}">
                                                {{ issue.assignee.username[:2]|upper }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    {% if issue.priority %}
                                    <span class="text-muted" title="{{ 'Priorität' if lang == 'de' else 'Priority' }}">
                                        <i class="bi bi-flag-fill"></i>
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-column-placeholder">
                            <i class="bi bi-inbox"></i><br>
                            {{ 'Keine Issues' if lang == 'de' else 'No issues' }}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize drag and drop for each column
    const columns = document.querySelectorAll('.sortable-column');
    
    columns.forEach(column => {
        new Sortable(column, {
            group: 'sprint-board',
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                const issueId = evt.item.dataset.issueId;
                const newStatusId = evt.to.dataset.statusId;
                const oldStatusId = evt.from.dataset.statusId;
                
                if (newStatusId !== oldStatusId) {
                    // Move issue to new status
                    fetch(`{{ url_for('projects.kanban_move', project_id=project.id) }}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            issue_id: parseInt(issueId),
                            new_status_id: parseInt(newStatusId),
                            position: evt.newIndex
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            // Revert the move
                            evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex]);
                            alert(data.error || '{{ "Fehler beim Verschieben" if lang == "de" else "Error moving issue" }}');
                        } else {
                            // Update counts
                            updateColumnCounts();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex]);
                    });
                }
            }
        });
    });
    
    function updateColumnCounts() {
        columns.forEach(column => {
            const count = column.querySelectorAll('.issue-card').length;
            const header = column.closest('.board-column').querySelector('.issue-count');
            if (header) {
                header.textContent = count;
            }
            
            // Show/hide empty placeholder
            const placeholder = column.querySelector('.empty-column-placeholder');
            if (count === 0 && !placeholder) {
                column.innerHTML = `<div class="empty-column-placeholder"><i class="bi bi-inbox"></i><br>{{ 'Keine Issues' if lang == 'de' else 'No issues' }}</div>`;
            } else if (count > 0 && placeholder) {
                placeholder.remove();
            }
        });
    }
});
</script>
{% endblock %}
