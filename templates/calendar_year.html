{% extends "base.html" %}

{% block title %}{{ t('year_view') }} - {{ year }}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1><i class="bi bi-calendar3 me-2"></i>{{ t('year_view') }} {{ year }}</h1>
    
    <!-- View Switcher -->
    <div class="btn-group">
        <a href="{{ url_for('calendar_year_view', year=year) }}" class="btn btn-success">
            <i class="bi bi-calendar3"></i> {{ t('year_view') }}
        </a>
        <a href="{{ url_for('calendar_view', year=year, month=today.month) }}" class="btn btn-outline-secondary">
            <i class="bi bi-calendar-month"></i> {{ t('month_view') }}
        </a>
        <a href="{{ url_for('calendar_week_view', year=year, week=today.isocalendar()[1]) }}" class="btn btn-outline-secondary">
            <i class="bi bi-calendar-week"></i> {{ t('week_view') }}
        </a>
    </div>
</div>

<!-- Year Navigation -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('calendar_year_view', year=year-1) }}" class="btn btn-outline-secondary">
                <i class="bi bi-chevron-left"></i> {{ year - 1 }}
            </a>
            <h3 class="mb-0">{{ year }}</h3>
            <a href="{{ url_for('calendar_year_view', year=year+1) }}" class="btn btn-outline-secondary">
                {{ year + 1 }} <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Year Grid -->
<div class="row g-3">
    {% for month in range(1, 13) %}
    <div class="col-md-4 col-lg-3">
        <div class="card h-100 month-card {% if today.year == year and today.month == month %}border-success border-2{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <a href="{{ url_for('calendar_view', year=year, month=month) }}" class="text-decoration-none text-dark fw-bold">
                    {{ month_names[month] }}
                </a>
                {% if month_stats[month].total > 0 %}
                <span class="badge bg-secondary">{{ month_stats[month].total }}</span>
                {% endif %}
            </div>
            <div class="card-body p-2">
                {% if month_stats[month].total > 0 %}
                <!-- Status Summary -->
                <div class="d-flex flex-wrap gap-1 mb-2">
                    {% if month_stats[month].overdue > 0 %}
                    <span class="badge bg-danger" title="{{ t('status_overdue') }}">
                        <i class="bi bi-exclamation-circle"></i> {{ month_stats[month].overdue }}
                    </span>
                    {% endif %}
                    {% if month_stats[month].in_review > 0 %}
                    <span class="badge bg-warning text-dark" title="{{ t('status_in_review') }}">
                        <i class="bi bi-hourglass-split"></i> {{ month_stats[month].in_review }}
                    </span>
                    {% endif %}
                    {% if month_stats[month].completed > 0 %}
                    <span class="badge bg-success" title="{{ t('status_completed') }}">
                        <i class="bi bi-check-circle"></i> {{ month_stats[month].completed }}
                    </span>
                    {% endif %}
                </div>
                
                <!-- Task List (first 5) -->
                <div class="task-list small">
                    {% for task in tasks_by_month[month][:5] %}
                    <div class="d-flex align-items-center mb-1">
                        <a href="{{ url_for('task_detail', task_id=task.id) }}" 
                           class="flex-grow-1 text-decoration-none text-truncate
                                  {% if task.status == 'completed' %}text-success
                                  {% elif task.is_overdue %}text-danger
                                  {% elif task.status == 'in_review' %}text-warning
                                  {% else %}text-secondary{% endif %}"
                           title="{{ task.title }}">
                            <small class="text-muted">{{ task.due_date.strftime('%d.') }}</small>
                            <strong>{{ task.entity.short_name or task.entity.name[:6] }}</strong>
                            {{ task.title[:12] }}{% if task.title|length > 12 %}…{% endif %}
                        </a>
                        <button type="button" class="btn btn-link btn-sm p-0 ms-1 task-preview-btn" 
                                data-bs-toggle="popover" 
                                data-bs-trigger="hover focus"
                                data-bs-html="true"
                                data-bs-placement="right"
                                data-bs-title="<i class='bi bi-info-circle me-1'></i>{{ task.title[:25] }}{% if task.title|length > 25 %}…{% endif %}"
                                data-bs-content="<small><strong>Mandant:</strong> {{ task.entity.name }}<br><strong>Status:</strong> {{ task.status }}<br><strong>Fällig:</strong> {{ task.due_date.strftime('%d.%m.%Y') }}{% if task.period %}<br><strong>Zeitraum:</strong> {{ task.period }}{% endif %}</small><hr class='my-1'><a href='{{ url_for('task_detail', task_id=task.id) }}' class='btn btn-sm btn-deloitte-green w-100'>Details</a>">
                            <i class="bi bi-eye-fill text-muted" style="font-size: 0.65rem;"></i>
                        </button>
                    </div>
                    {% endfor %}
                    {% if tasks_by_month[month]|length > 5 %}
                    <a href="{{ url_for('calendar_view', year=year, month=month) }}" class="d-block text-muted small">
                        +{{ tasks_by_month[month]|length - 5 }} {{ t('more') }}...
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-muted text-center small py-3">
                    {{ t('no_tasks') }}
                </div>
                {% endif %}
            </div>
            
            <!-- Progress Bar -->
            {% if month_stats[month].total > 0 %}
            <div class="card-footer p-2">
                <div class="progress" style="height: 6px;">
                    {% set pct = (month_stats[month].completed / month_stats[month].total * 100)|int %}
                    <div class="progress-bar bg-success" style="width: {{ pct }}%"></div>
                </div>
                <small class="text-muted">{{ pct }}% {{ t('status_completed') }}</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Legend -->
<div class="card mt-4">
    <div class="card-body">
        <h6 class="card-title mb-3">{{ t('legend') }}</h6>
        <div class="d-flex flex-wrap gap-3">
            <span><span class="badge bg-danger">&nbsp;&nbsp;</span> {{ t('status_overdue') }}</span>
            <span><span class="badge bg-warning text-dark">&nbsp;&nbsp;</span> {{ t('status_in_review') }}</span>
            <span><span class="badge bg-success">&nbsp;&nbsp;</span> {{ t('status_completed') }}</span>
            <span><span class="badge bg-secondary">&nbsp;&nbsp;</span> {{ t('status_draft') }}</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .month-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .month-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .month-card .card-header {
        background: var(--del-gray-light);
        font-size: 0.95rem;
    }
    
    .task-list a:hover {
        text-decoration: underline !important;
    }
    
    .task-preview-btn {
        opacity: 0.4;
        transition: opacity 0.2s;
    }
    
    .task-preview-btn:hover {
        opacity: 1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize all popovers
document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function(popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            container: 'body',
            sanitize: false
        });
    });
});
</script>
{% endblock %}
