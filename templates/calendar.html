{% extends "base.html" %}

{% block title %}{{ t('nav_calendar') }} - {{ month_name }} {{ year }}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1><i class="bi bi-calendar-month me-2"></i>{{ t('month_view') }}</h1>
    
    <!-- View Switcher -->
    <div class="btn-group">
        <a href="{{ url_for('calendar_year_view', year=year) }}" class="btn btn-outline-secondary">
            <i class="bi bi-calendar3"></i> {{ t('year_view') }}
        </a>
        <a href="{{ url_for('calendar_view', year=year, month=month) }}" class="btn btn-success">
            <i class="bi bi-calendar-month"></i> {{ t('month_view') }}
        </a>
        <a href="{{ url_for('calendar_week_view', year=year, week=today.isocalendar()[1]) }}" class="btn btn-outline-secondary">
            <i class="bi bi-calendar-week"></i> {{ t('week_view') }}
        </a>
    </div>
</div>

<!-- Month Navigation -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('calendar_view', year=prev_year, month=prev_month) }}" class="btn btn-outline-secondary">
                <i class="bi bi-chevron-left"></i> {{ t('calendar_prev') }}
            </a>
            <h3 class="mb-0">{{ month_name }} {{ year }}</h3>
            <a href="{{ url_for('calendar_view', year=next_year, month=next_month) }}" class="btn btn-outline-secondary">
                {{ t('calendar_next') }} <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Calendar Grid - Main Column -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-body p-0">
                <table class="table table-bordered mb-0 calendar-table">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">{{ t('weekday_mon') }}</th>
                            <th class="text-center">{{ t('weekday_tue') }}</th>
                            <th class="text-center">{{ t('weekday_wed') }}</th>
                            <th class="text-center">{{ t('weekday_thu') }}</th>
                            <th class="text-center">{{ t('weekday_fri') }}</th>
                            <th class="text-center bg-secondary">{{ t('weekday_sat') }}</th>
                            <th class="text-center bg-secondary">{{ t('weekday_sun') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in month_days %}
                        <tr>
                            {% for day in week %}
                            <td class="calendar-cell {% if day == 0 %}bg-light{% endif %} {% if day == today.day and month == today.month and year == today.year %}today{% endif %}">
                                {% if day != 0 %}
                                <div class="day-number {% if day == today.day and month == today.month and year == today.year %}text-white bg-success rounded-circle px-2{% endif %}">
                                    {{ day }}
                                </div>
                                {% if tasks_by_day.get(day) %}
                                <div class="task-list mt-1">
                                    {% for task in tasks_by_day[day][:3] %}
                                    <div class="task-item d-flex align-items-center mb-1">
                                        <a href="{{ url_for('task_detail', task_id=task.id) }}" 
                                           class="task-badge flex-grow-1 text-decoration-none"
                                           title="{{ task.title }}">
                                            <span class="badge w-100 text-start text-truncate 
                                                {% if task.status == 'completed' %}bg-success
                                                {% elif task.status == 'in_review' %}bg-warning text-dark
                                                {% elif task.is_overdue %}bg-danger
                                                {% elif task.is_due_soon %}bg-warning text-dark
                                                {% else %}bg-secondary{% endif %}">
                                                {{ task.title[:12] }}{% if task.title|length > 12 %}…{% endif %}
                                            </span>
                                        </a>
                                        {% set cal_reviewers = task.reviewers.all() %}
                                        {% set cal_approval = task.get_approval_count() %}
                                        {% set cal_evidence = task.evidence.count() %}
                                        {% set cal_comments = task.comments.count() %}
                                        <button type="button" class="btn btn-link btn-sm p-0 ms-1 task-preview-btn" 
                                                data-bs-toggle="popover" 
                                                data-bs-html="true"
                                                data-bs-placement="right"
                                                data-bs-title="<div class='d-flex justify-content-between align-items-center w-100'><span><i class='bi bi-clipboard-check me-1'></i>{{ task.title[:30] }}{% if task.title|length > 30 %}…{% endif %}</span><button class='btn btn-link btn-sm p-0 ms-2 popover-pin-btn' title='{{ 'Fixieren' if lang == 'de' else 'Pin' }}'><i class='bi bi-pin'></i></button></div>"
                                                data-bs-content="
                                                    <div class='small'>
                                                        {% if task.is_overdue %}<div class='alert alert-danger py-1 px-2 mb-2'><i class='bi bi-exclamation-triangle me-1'></i><strong>{{ 'Überfällig!' if lang == 'de' else 'Overdue!' }}</strong></div>{% elif task.is_due_soon %}<div class='alert alert-warning py-1 px-2 mb-2'><i class='bi bi-clock me-1'></i><strong>{{ 'Bald fällig' if lang == 'de' else 'Due soon' }}</strong></div>{% endif %}
                                                        <table class='table table-sm table-borderless mb-2' style='font-size: 0.8rem;'>
                                                            <tr><td class='text-muted pe-2' style='width:40%;'>{{ 'Mandant' if lang == 'de' else 'Entity' }}:</td><td><strong>{{ task.entity.get_name(lang) }}</strong></td></tr>
                                                            <tr><td class='text-muted'>{{ 'Fällig' if lang == 'de' else 'Due' }}:</td><td class='{{ 'text-danger fw-bold' if task.is_overdue else '' }}'>{{ task.due_date.strftime('%d.%m.%Y') }}</td></tr>
                                                            <tr><td class='text-muted'>Status:</td><td><span class='badge {% if task.status == 'completed' %}bg-success{% elif task.status == 'in_review' %}bg-info{% elif task.status == 'submitted' %}bg-primary{% elif task.status == 'rejected' %}bg-danger{% else %}bg-secondary{% endif %}'>{{ task.status }}</span></td></tr>
                                                            {% if task.period %}<tr><td class='text-muted'>{{ 'Zeitraum' if lang == 'de' else 'Period' }}:</td><td>{{ task.period }}</td></tr>{% endif %}
                                                            {% if task.template and task.template.tax_type %}<tr><td class='text-muted'>{{ 'Steuerart' if lang == 'de' else 'Tax type' }}:</td><td>{{ task.template.tax_type.code }}</td></tr>{% endif %}
                                                        </table>
                                                        <hr class='my-2'>
                                                        <div class='mb-2'>
                                                            <div class='d-flex align-items-center gap-1 mb-1'>
                                                                <i class='bi bi-person text-muted'></i>
                                                                <span class='text-muted'>{{ 'Bearbeiter' if lang == 'de' else 'Owner' }}:</span>
                                                                <strong>{{ task.owner.name if task.owner else '-' }}</strong>
                                                            </div>
                                                            {% if task.owner_team %}
                                                            <div class='d-flex align-items-center gap-1 mb-1'>
                                                                <i class='bi bi-people text-muted'></i>
                                                                <span class='text-muted'>Team:</span>
                                                                <span class='d-inline-block rounded-circle' style='width:8px;height:8px;background-color:{{ task.owner_team.color or '#86BC25' }};'></span>
                                                                <span>{{ task.owner_team.get_name(lang) }}</span>
                                                            </div>
                                                            {% endif %}
                                                            <div class='d-flex align-items-center gap-1'>
                                                                <i class='bi bi-check2-circle text-muted'></i>
                                                                <span class='text-muted'>{{ 'Prüfer' if lang == 'de' else 'Reviewers' }}:</span>
                                                                {% if cal_reviewers %}
                                                                    <span>{{ cal_approval[0] }}/{{ cal_approval[1] }} {{ 'genehmigt' if lang == 'de' else 'approved' }}</span>
                                                                {% elif task.reviewer_team %}
                                                                    <span>{{ task.reviewer_team.get_name(lang) }}</span>
                                                                {% else %}
                                                                    <span>-</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        <hr class='my-2'>
                                                        <div class='d-flex justify-content-between text-muted mb-2'>
                                                            <span><i class='bi bi-paperclip me-1'></i>{{ cal_evidence }} {{ 'Belege' if lang == 'de' else 'Evidence' }}</span>
                                                            <span><i class='bi bi-chat-dots me-1'></i>{{ cal_comments }} {{ 'Kommentare' if lang == 'de' else 'Comments' }}</span>
                                                        </div>
                                                    </div>
                                                    <a href='{{ url_for('task_detail', task_id=task.id) }}' class='btn btn-sm btn-deloitte-green w-100'><i class='bi bi-arrow-right me-1'></i>{{ 'Details öffnen' if lang == 'de' else 'Open Details' }}</a>
                                                ">
                                            <i class="bi bi-eye-fill" style="font-size: 0.65rem;"></i>
                                        </button>
                                    </div>
                                    {% endfor %}
                                    {% if tasks_by_day[day]|length > 3 %}
                                    <a href="{{ url_for('task_list') }}?due_date={{ year }}-{{ '%02d'|format(month) }}-{{ '%02d'|format(day) }}" 
                                       class="badge bg-secondary w-100">
                                        +{{ tasks_by_day[day]|length - 3 }} {{ t('more') }}
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Legend -->
        <div class="card mt-4">
            <div class="card-body py-2">
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    <small class="text-muted fw-bold">{{ t('legend') }}:</small>
                    <small><span class="badge bg-danger">&nbsp;&nbsp;</span> {{ t('status_overdue') }}</small>
                    <small><span class="badge bg-warning text-dark">&nbsp;&nbsp;</span> {{ t('status_due_soon') }} / {{ t('status_in_review') }}</small>
                    <small><span class="badge bg-secondary">&nbsp;&nbsp;</span> {{ t('status_draft') }}</small>
                    <small><span class="badge bg-success">&nbsp;&nbsp;</span> {{ t('status_completed') }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar - Task List -->
    <div class="col-lg-3">
        <!-- Month Summary -->
        <div class="card mb-3">
            <div class="card-header bg-dark text-white py-2">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>{% if lang == 'de' %}Monatsübersicht{% else %}Month Summary{% endif %}</h6>
            </div>
            <div class="card-body p-0">
                {% set all_tasks = [] %}
                {% for day, day_tasks in tasks_by_day.items() %}
                    {% for task in day_tasks %}
                        {% set _ = all_tasks.append(task) %}
                    {% endfor %}
                {% endfor %}
                {% set total = all_tasks|length %}
                {% set completed = all_tasks|selectattr('status', 'equalto', 'completed')|list|length %}
                {% set in_review = all_tasks|selectattr('status', 'equalto', 'in_review')|list|length %}
                {% set overdue = all_tasks|selectattr('is_overdue')|list|length %}
                
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <small>{% if lang == 'de' %}Gesamt{% else %}Total{% endif %}</small>
                        <span class="badge bg-primary rounded-pill">{{ total }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <small>{% if lang == 'de' %}Erledigt{% else %}Completed{% endif %}</small>
                        <span class="badge bg-success rounded-pill">{{ completed }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <small>{% if lang == 'de' %}In Prüfung{% else %}In Review{% endif %}</small>
                        <span class="badge bg-warning text-dark rounded-pill">{{ in_review }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <small>{% if lang == 'de' %}Überfällig{% else %}Overdue{% endif %}</small>
                        <span class="badge bg-danger rounded-pill">{{ overdue }}</span>
                    </li>
                </ul>
                
                {% if total > 0 %}
                <div class="p-2">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: {{ (completed / total * 100)|int }}%"></div>
                        <div class="progress-bar bg-warning" style="width: {{ (in_review / total * 100)|int }}%"></div>
                        <div class="progress-bar bg-danger" style="width: {{ (overdue / total * 100)|int }}%"></div>
                    </div>
                    <small class="text-muted">{{ ((completed / total) * 100)|int }}% {% if lang == 'de' %}abgeschlossen{% else %}complete{% endif %}</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Task List for Current Month -->
        <div class="card">
            <div class="card-header bg-dark text-white py-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-list-task me-2"></i>{% if lang == 'de' %}Aufgaben{% else %}Tasks{% endif %}</h6>
                <span class="badge bg-light text-dark">{{ total }}</span>
            </div>
            <div class="card-body p-0 sidebar-task-list">
                {% if total == 0 %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-calendar-x fs-1 d-block mb-2"></i>
                    <small>{% if lang == 'de' %}Keine Aufgaben in diesem Monat{% else %}No tasks this month{% endif %}</small>
                </div>
                {% else %}
                <div class="list-group list-group-flush">
                    {% for day in tasks_by_day.keys()|sort %}
                    {% for task in tasks_by_day[day] %}
                    <div class="list-group-item py-2 px-3 sidebar-task-item
                              {% if task.status == 'completed' %}list-group-item-success
                              {% elif task.is_overdue %}list-group-item-danger
                              {% elif task.status == 'in_review' %}list-group-item-warning
                              {% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="flex-grow-1 me-2 text-decoration-none text-dark" style="min-width: 0;">
                                <div class="fw-semibold text-truncate" style="font-size: 0.85rem;">
                                    {{ task.title[:25] }}{% if task.title|length > 25 %}…{% endif %}
                                </div>
                                <small class="text-muted d-block text-truncate">
                                    {{ task.entity.name[:18] }}{% if task.entity.name|length > 18 %}…{% endif %}
                                </small>
                            </a>
                            <div class="d-flex align-items-center" style="flex-shrink: 0;">
                                {% set sb_reviewers = task.reviewers.all() %}
                                {% set sb_approval = task.get_approval_count() %}
                                {% set sb_evidence = task.evidence.count() %}
                                {% set sb_comments = task.comments.count() %}
                                <button type="button" class="btn btn-link btn-sm p-0 me-2 sidebar-preview-btn" 
                                        data-bs-toggle="popover" 
                                        data-bs-html="true"
                                        data-bs-placement="left"
                                        data-bs-title="<div class='d-flex justify-content-between align-items-center w-100'><span><i class='bi bi-clipboard-check me-1'></i>{{ task.title[:30] }}{% if task.title|length > 30 %}…{% endif %}</span><button class='btn btn-link btn-sm p-0 ms-2 popover-pin-btn' title='{{ 'Fixieren' if lang == 'de' else 'Pin' }}'><i class='bi bi-pin'></i></button></div>"
                                        data-bs-content="
                                            <div class='small'>
                                                {% if task.is_overdue %}<div class='alert alert-danger py-1 px-2 mb-2'><i class='bi bi-exclamation-triangle me-1'></i><strong>{{ 'Überfällig!' if lang == 'de' else 'Overdue!' }}</strong></div>{% elif task.is_due_soon %}<div class='alert alert-warning py-1 px-2 mb-2'><i class='bi bi-clock me-1'></i><strong>{{ 'Bald fällig' if lang == 'de' else 'Due soon' }}</strong></div>{% endif %}
                                                <table class='table table-sm table-borderless mb-2' style='font-size: 0.8rem;'>
                                                    <tr><td class='text-muted pe-2' style='width:40%;'>{{ 'Mandant' if lang == 'de' else 'Entity' }}:</td><td><strong>{{ task.entity.get_name(lang) }}</strong></td></tr>
                                                    <tr><td class='text-muted'>{{ 'Fällig' if lang == 'de' else 'Due' }}:</td><td class='{{ 'text-danger fw-bold' if task.is_overdue else '' }}'>{{ task.due_date.strftime('%d.%m.%Y') }}</td></tr>
                                                    <tr><td class='text-muted'>Status:</td><td><span class='badge {% if task.status == 'completed' %}bg-success{% elif task.status == 'in_review' %}bg-info{% elif task.status == 'submitted' %}bg-primary{% elif task.status == 'rejected' %}bg-danger{% else %}bg-secondary{% endif %}'>{{ task.status }}</span></td></tr>
                                                    {% if task.period %}<tr><td class='text-muted'>{{ 'Zeitraum' if lang == 'de' else 'Period' }}:</td><td>{{ task.period }}</td></tr>{% endif %}
                                                    {% if task.template and task.template.tax_type %}<tr><td class='text-muted'>{{ 'Steuerart' if lang == 'de' else 'Tax type' }}:</td><td>{{ task.template.tax_type.code }}</td></tr>{% endif %}
                                                </table>
                                                <hr class='my-2'>
                                                <div class='mb-2'>
                                                    <div class='d-flex align-items-center gap-1 mb-1'>
                                                        <i class='bi bi-person text-muted'></i>
                                                        <span class='text-muted'>{{ 'Bearbeiter' if lang == 'de' else 'Owner' }}:</span>
                                                        <strong>{{ task.owner.name if task.owner else '-' }}</strong>
                                                    </div>
                                                    {% if task.owner_team %}
                                                    <div class='d-flex align-items-center gap-1 mb-1'>
                                                        <i class='bi bi-people text-muted'></i>
                                                        <span class='text-muted'>Team:</span>
                                                        <span class='d-inline-block rounded-circle' style='width:8px;height:8px;background-color:{{ task.owner_team.color or '#86BC25' }};'></span>
                                                        <span>{{ task.owner_team.get_name(lang) }}</span>
                                                    </div>
                                                    {% endif %}
                                                    <div class='d-flex align-items-center gap-1'>
                                                        <i class='bi bi-check2-circle text-muted'></i>
                                                        <span class='text-muted'>{{ 'Prüfer' if lang == 'de' else 'Reviewers' }}:</span>
                                                        {% if sb_reviewers %}
                                                            <span>{{ sb_approval[0] }}/{{ sb_approval[1] }} {{ 'genehmigt' if lang == 'de' else 'approved' }}</span>
                                                        {% elif task.reviewer_team %}
                                                            <span>{{ task.reviewer_team.get_name(lang) }}</span>
                                                        {% else %}
                                                            <span>-</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <hr class='my-2'>
                                                <div class='d-flex justify-content-between text-muted mb-2'>
                                                    <span><i class='bi bi-paperclip me-1'></i>{{ sb_evidence }} {{ 'Belege' if lang == 'de' else 'Evidence' }}</span>
                                                    <span><i class='bi bi-chat-dots me-1'></i>{{ sb_comments }} {{ 'Kommentare' if lang == 'de' else 'Comments' }}</span>
                                                </div>
                                            </div>
                                            <a href='{{ url_for('task_detail', task_id=task.id) }}' class='btn btn-sm btn-deloitte-green w-100'><i class='bi bi-arrow-right me-1'></i>{{ 'Details öffnen' if lang == 'de' else 'Open Details' }}</a>
                                        ">
                                    <i class="bi bi-eye-fill text-secondary"></i>
                                </button>
                                <div class="text-end">
                                    <div class="badge {% if task.is_overdue %}bg-danger{% elif task.is_due_soon %}bg-warning text-dark{% else %}bg-secondary{% endif %}" style="font-size: 0.7rem;">
                                        {{ day }}.{{ '%02d'|format(month) }}.
                                    </div>
                                    <div class="mt-1">
                                        {% if task.status == 'completed' %}
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        {% elif task.status == 'in_review' %}
                                        <i class="bi bi-hourglass-split text-warning"></i>
                                        {% elif task.is_overdue %}
                                        <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                        {% else %}
                                        <i class="bi bi-circle text-secondary"></i>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Add Button -->
        <div class="d-grid mt-3">
            <a href="{{ url_for('task_create') }}" class="btn btn-success">
                <i class="bi bi-plus-lg me-2"></i>{% if lang == 'de' %}Neue Aufgabe{% else %}New Task{% endif %}
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .calendar-table {
        table-layout: fixed;
    }
    
    .calendar-cell {
        height: 120px;
        vertical-align: top;
        padding: 0.5rem !important;
        width: 14.28%;
    }
    
    .calendar-cell.today {
        background-color: rgba(var(--del-green-rgb), 0.1) !important;
        border: 2px solid var(--del-green) !important;
    }
    
    .day-number {
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-block;
    }
    
    .task-list {
        font-size: 0.75rem;
    }
    
    .task-badge .badge {
        font-size: 0.65rem;
        padding: 0.25rem 0.4rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .task-badge:hover .badge {
        opacity: 0.85;
    }
    
    /* Wider popovers for task preview */
    .popover {
        max-width: 350px !important;
    }
    
    .popover .table {
        margin-bottom: 0;
    }
    
    .popover .table td {
        padding: 0.15rem 0.25rem;
    }
    
    .popover-header {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
    }
    
    .popover-pin-btn {
        color: #6c757d;
        transition: color 0.2s;
    }
    
    .popover-pin-btn:hover {
        color: var(--dtt-green-3);
    }
    
    .popover-pin-btn.text-success {
        color: var(--dtt-green-3) !important;
    }
    
    .task-item {
        line-height: 1;
    }
    
    /* Preview button styles */
    .task-preview-btn {
        opacity: 0.6;
        transition: opacity 0.2s;
        color: inherit;
    }
    
    .task-preview-btn:hover {
        opacity: 1;
    }
    
    .sidebar-preview-btn {
        opacity: 0.5;
        transition: opacity 0.2s;
    }
    
    .sidebar-preview-btn:hover {
        opacity: 1;
    }
    
    .sidebar-task-item:hover .sidebar-preview-btn {
        opacity: 0.8;
    }
    
    /* Sidebar styles */
    .sidebar-task-list {
        max-height: 450px;
        overflow-y: auto;
    }
    
    .sidebar-task-item {
        transition: all 0.15s ease;
        border-left: 3px solid transparent !important;
    }
    
    .sidebar-task-item:hover {
        border-left: 3px solid var(--bs-primary) !important;
        background-color: rgba(0,0,0,0.02);
    }
    
    .sidebar-task-item.list-group-item-danger {
        border-left-color: var(--bs-danger) !important;
    }
    
    .sidebar-task-item.list-group-item-success {
        border-left-color: var(--bs-success) !important;
    }
    
    .sidebar-task-item.list-group-item-warning {
        border-left-color: var(--bs-warning) !important;
    }
    
    @media (max-width: 992px) {
        .sidebar-task-list {
            max-height: 300px;
        }
    }
    
    @media (max-width: 768px) {
        .calendar-cell {
            height: 80px;
            padding: 0.25rem !important;
        }
        
        .task-list {
            display: none;
        }
        
        .calendar-cell.has-tasks::after {
            content: "•";
            color: var(--del-green);
            font-size: 1.5rem;
            display: block;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize all popovers with hover-intent behavior
document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.forEach(function(popoverTriggerEl) {
        var popover = new bootstrap.Popover(popoverTriggerEl, {
            container: 'body',
            sanitize: false,
            trigger: 'manual'
        });
        
        var hideTimeout = null;
        var isOverTrigger = false;
        var isOverPopover = false;
        var isPinned = false;
        
        function showPopover() {
            clearTimeout(hideTimeout);
            // Hide any other open popovers first
            document.querySelectorAll('.popover.show').forEach(function(p) {
                var existingPopover = bootstrap.Popover.getInstance(p);
                if (existingPopover) existingPopover.hide();
            });
            popover.show();
            setTimeout(function() {
                var popoverEl = document.querySelector('.popover');
                if (popoverEl) {
                    popoverEl.addEventListener('mouseenter', function() {
                        isOverPopover = true;
                        clearTimeout(hideTimeout);
                    });
                    popoverEl.addEventListener('mouseleave', function() {
                        isOverPopover = false;
                        if (!isPinned) scheduleHide();
                    });
                    var pinBtn = popoverEl.querySelector('.popover-pin-btn');
                    if (pinBtn) {
                        pinBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            isPinned = !isPinned;
                            this.classList.toggle('text-success', isPinned);
                            this.querySelector('i').className = isPinned ? 'bi bi-pin-fill' : 'bi bi-pin';
                        });
                    }
                }
            }, 10);
        }
        
        function scheduleHide() {
            hideTimeout = setTimeout(function() {
                if (!isOverTrigger && !isOverPopover && !isPinned) {
                    popover.hide();
                }
            }, 150);
        }
        
        popoverTriggerEl.addEventListener('mouseenter', function() {
            isOverTrigger = true;
            showPopover();
        });
        
        popoverTriggerEl.addEventListener('mouseleave', function() {
            isOverTrigger = false;
            if (!isPinned) scheduleHide();
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                isPinned = false;
                popover.hide();
            }
        });
        
        document.addEventListener('click', function(e) {
            var popoverEl = document.querySelector('.popover');
            if (popoverEl && !popoverEl.contains(e.target) && !popoverTriggerEl.contains(e.target)) {
                isPinned = false;
                popover.hide();
            }
        });
    });
});
</script>
{% endblock %}
