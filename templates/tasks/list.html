{% extends "base.html" %}
{% block title %}{{ t('tasks') }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-list-task me-2"></i>{{ t('tasks') }}</h1>
        <a href="{{ url_for('task_create') }}" class="btn btn-success">
            <i class="bi bi-plus-circle me-1"></i> {{ t('new_task') }}
        </a>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">{{ t('status') }}</label>
                    <select name="status" class="form-select form-select-sm">
                        <option value="">{{ t('all') if lang == 'en' else 'Alle' }}</option>
                        <option value="overdue" {{ 'selected' if current_filters.status == 'overdue' }}>{{ t('status_overdue') }}</option>
                        <option value="due_soon" {{ 'selected' if current_filters.status == 'due_soon' }}>{{ t('status_due_soon') }}</option>
                        <option value="draft" {{ 'selected' if current_filters.status == 'draft' }}>{{ t('status_draft') }}</option>
                        <option value="submitted" {{ 'selected' if current_filters.status == 'submitted' }}>{{ t('status_submitted') }}</option>
                        <option value="in_review" {{ 'selected' if current_filters.status == 'in_review' }}>{{ t('status_in_review') }}</option>
                        <option value="completed" {{ 'selected' if current_filters.status == 'completed' }}>{{ t('status_completed') }}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">{{ t('entity') }}</label>
                    <select name="entity" class="form-select form-select-sm">
                        <option value="">{{ t('all') if lang == 'en' else 'Alle' }}</option>
                        {% for entity in entities %}
                        <option value="{{ entity.id }}" {{ 'selected' if current_filters.entity == entity.id }}>
                            {{ entity.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ t('tax_type') }}</label>
                    <select name="tax_type" class="form-select form-select-sm">
                        <option value="">{{ t('all') if lang == 'en' else 'Alle' }}</option>
                        {% for tt in tax_types %}
                        <option value="{{ tt.id }}" {{ 'selected' if current_filters.tax_type == tt.id }}>
                            {{ tt.code }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">{{ t('year') if lang == 'en' else 'Jahr' }}</label>
                    <select name="year" class="form-select form-select-sm">
                        {% for year in years %}
                        <option value="{{ year }}" {{ 'selected' if current_filters.year == year }}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-funnel me-1"></i>{{ t('filter') if lang == 'en' else 'Filtern' }}
                    </button>
                    <a href="{{ url_for('task_list') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-x-lg me-1"></i>{{ t('reset') if lang == 'en' else 'Zurücksetzen' }}
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Task List -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>{{ t('status') }}</th>
                            <th>{{ t('due_date') }}</th>
                            <th>{{ t('task') }}</th>
                            <th>{{ t('entity') }}</th>
                            <th>{{ t('tax_type') }}</th>
                            <th>{{ t('owner') }}</th>
                            <th>{{ t('reviewer') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr class="task-row">
                            <td onclick="event.stopPropagation();">
                                <button type="button" class="btn btn-link btn-sm p-0 task-preview-btn" 
                                        data-bs-toggle="popover" 
                                        data-bs-trigger="hover focus"
                                        data-bs-html="true"
                                        data-bs-placement="right"
                                        data-bs-title="<i class='bi bi-info-circle me-1'></i>{{ task.title[:35] }}{% if task.title|length > 35 %}…{% endif %}"
                                        data-bs-content="<div class='small'><strong>Mandant:</strong> {{ task.entity.name }}<br><strong>Status:</strong> {{ task.status }}<br><strong>Fällig:</strong> {{ task.due_date.strftime('%d.%m.%Y') }}{% if task.period %}<br><strong>Zeitraum:</strong> {{ task.period }}{% endif %}{% if task.template and task.template.tax_type %}<br><strong>Steuerart:</strong> {{ task.template.tax_type.name }}{% endif %}{% if task.owner %}<br><strong>Bearbeiter:</strong> {{ task.owner.name }}{% endif %}{% if task.description %}<hr class='my-1'><em>{{ task.description[:80] }}{% if task.description|length > 80 %}…{% endif %}</em>{% endif %}</div><hr class='my-1'><a href='{{ url_for('task_detail', task_id=task.id) }}' class='btn btn-sm btn-deloitte-green w-100'><i class='bi bi-arrow-right me-1'></i>Details öffnen</a>">
                                    <i class="bi bi-eye-fill text-primary" style="font-size: 1rem;"></i>
                                </button>
                            </td>
                            <td onclick="window.location='{{ url_for('task_detail', task_id=task.id) }}'" style="cursor: pointer;">
                                {% if task.status == 'completed' %}
                                <span class="badge" style="background-color: var(--dtt-sec-green-5);">
                                    {{ t('status_completed') }}
                                </span>
                                {% elif task.is_overdue %}
                                <span class="badge" style="background-color: var(--dtt-danger-red);">
                                    {{ t('status_overdue') }}
                                </span>
                                {% elif task.is_due_soon %}
                                <span class="badge" style="background-color: var(--dtt-warning-orange);">
                                    {{ t('status_due_soon') }}
                                </span>
                                {% elif task.status == 'submitted' %}
                                <span class="badge" style="background-color: var(--dtt-sec-blue-4);">
                                    {{ t('status_submitted') }}
                                </span>
                                {% elif task.status == 'in_review' %}
                                <span class="badge" style="background-color: var(--dtt-sec-teal-6);">
                                    {{ t('status_in_review') }}
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">
                                    {{ t('status_draft') }}
                                </span>
                                {% endif %}
                            </td>
                            <td class="clickable-cell">
                                <span class="{{ 'text-danger fw-bold' if task.is_overdue else '' }}">
                                    {{ task.due_date.strftime('%d.%m.%Y') }}
                                </span>
                            </td>
                            <td class="clickable-cell">
                                <strong>{{ task.title }}</strong>
                                {% if task.period %}
                                <br><small class="text-muted">{{ task.period }}</small>
                                {% endif %}
                            </td>
                            <td class="clickable-cell">{{ task.entity.short_name or task.entity.name }}</td>
                            <td class="clickable-cell">
                                {% if task.template %}
                                <span class="badge bg-light text-dark">{{ task.template.tax_type.code }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td class="clickable-cell">
                                {% if task.owner %}
                                <small>{{ task.owner.name }}</small>
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td class="clickable-cell">
                                {% if task.reviewer %}
                                <small>{{ task.reviewer.name }}</small>
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                {{ t('no_tasks') }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white">
            <small class="text-muted">{{ tasks|length }} {{ t('tasks') }}</small>
        </div>
    </div>
</div>

<style>
    .task-row:hover {
        background-color: var(--dtt-green-pale, #f8f9fa);
    }
    
    .clickable-cell {
        cursor: pointer;
    }
    
    .task-preview-btn {
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
    }
    
    .task-preview-btn:hover {
        opacity: 1;
        transform: scale(1.2);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// Make clickable cells navigate to task detail
document.querySelectorAll('.clickable-cell').forEach(function(cell) {
    var row = cell.closest('tr');
    var link = row.querySelector('.task-preview-btn');
    if (link) {
        var href = link.getAttribute('data-bs-content');
        var match = href.match(/href='([^']+)'/);
        if (match) {
            cell.onclick = function() { window.location = match[1]; };
        }
    }
});

// Initialize all popovers
document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function(popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            container: 'body',
            sanitize: false
        });
    });
});
</script>
{% endblock %}
