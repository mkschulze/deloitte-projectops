{% extends "base.html" %}
{% block title %}{{ 'Mitglieder' if lang == 'de' else 'Members' }} - {{ tenant.name }} - {{ app_name }}{% endblock %}

{% block content %}
<style nonce="{{ csp_nonce }}">
    .members-hero {
        background: linear-gradient(135deg, #0076A8 0%, #005a82 50%, #003d5c 100%);
        color: white;
        padding: 2rem 0;
        margin: -1rem -1rem 2rem -1rem;
        border-radius: 0 0 1.5rem 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 118, 168, 0.3);
    }
    .member-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border: none;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .member-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }
    .member-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.25rem;
        font-weight: 600;
        color: #212529;
    }
    .member-row {
        transition: background-color 0.2s;
    }
    .member-row:hover {
        background-color: rgba(0, 118, 168, 0.05);
    }
    .member-avatar {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
        color: white;
    }
    .role-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }
    .role-admin { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
    .role-manager { background: rgba(255, 193, 7, 0.15); color: #d39e00; }
    .role-member { background: rgba(0, 118, 168, 0.15); color: #0076A8; }
    .role-viewer { background: rgba(108, 117, 125, 0.15); color: #6c757d; }
    
    .add-form-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px dashed #dee2e6;
        border-radius: 1rem;
        transition: all 0.2s;
    }
    .add-form-card:hover {
        border-color: #86BC25;
        background: linear-gradient(135deg, #f8fff0 0%, #ffffff 100%);
    }
    .stat-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 600;
    }
    .role-legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        background: #f8f9fa;
        margin-bottom: 0.5rem;
        transition: background 0.2s;
    }
    .role-legend-item:hover {
        background: #e9ecef;
    }
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
</style>

<div class="container-fluid">
    <!-- Hero Section -->
    <div class="members-hero px-4">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb mb-0" style="--bs-breadcrumb-divider-color: rgba(255,255,255,0.5);">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('admin_tenants.tenant_list') }}" class="text-white-50 text-decoration-none">
                        {{ 'Mandanten' if lang == 'de' else 'Tenants' }}
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('admin_tenants.tenant_detail', tenant_id=tenant.id) }}" class="text-white-50 text-decoration-none">
                        {{ tenant.name }}
                    </a>
                </li>
                <li class="breadcrumb-item text-white active">{{ 'Mitglieder' if lang == 'de' else 'Members' }}</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-people me-2"></i>{{ 'Mitglieder verwalten' if lang == 'de' else 'Manage Members' }}
                </h1>
                <p class="mb-0 opacity-75">{{ tenant.name }}</p>
            </div>
            <div class="d-flex gap-3">
                <span class="stat-badge">
                    <i class="bi bi-person-check me-1"></i>{{ memberships|length }} {{ 'Mitglieder' if lang == 'de' else 'Members' }}
                </span>
            </div>
        </div>
    </div>
    
    <div class="row g-4 px-3">
        <!-- Add Member Form -->
        <div class="col-lg-4">
            <div class="add-form-card p-4">
                <h5 class="mb-4">
                    <i class="bi bi-person-plus me-2 text-success"></i>
                    {{ 'Benutzer hinzuf√ºgen' if lang == 'de' else 'Add User' }}
                </h5>
                <form action="{{ url_for('admin_tenants.tenant_add_member', tenant_id=tenant.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="user_id" class="form-label fw-medium">{{ 'Benutzer' if lang == 'de' else 'User' }}</label>
                        <select class="form-select" id="user_id" name="user_id" required>
                            <option value="">{{ 'Benutzer w√§hlen...' if lang == 'de' else 'Select user...' }}</option>
                            {% for user in available_users %}
                            <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
                            {% endfor %}
                        </select>
                        {% if not available_users %}
                        <div class="form-text text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            {{ 'Alle Benutzer sind bereits Mitglieder' if lang == 'de' else 'All users are already members' }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="role" class="form-label fw-medium">{{ 'Rolle' if lang == 'de' else 'Role' }}</label>
                        <select class="form-select" id="role" name="role">
                            <option value="viewer">üîç Viewer</option>
                            <option value="member" selected>üë§ Member</option>
                            <option value="manager">‚öôÔ∏è Manager</option>
                            <option value="admin">üõ°Ô∏è Admin</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100" style="border-radius: 0.75rem; padding: 0.75rem;" 
                            {% if not available_users %}disabled{% endif %}>
                        <i class="bi bi-plus-lg me-2"></i>{{ 'Hinzuf√ºgen' if lang == 'de' else 'Add' }}
                    </button>
                </form>
            </div>
            
            <!-- Role Legend -->
            <div class="member-card mt-4">
                <div class="card-header">
                    <i class="bi bi-shield-check me-2 text-primary"></i>
                    {{ 'Rollen-√úbersicht' if lang == 'de' else 'Role Overview' }}
                </div>
                <div class="card-body">
                    <div class="role-legend-item">
                        <span class="role-badge role-admin">
                            <i class="bi bi-shield-fill"></i>Admin
                        </span>
                        <small class="text-muted flex-grow-1">{{ 'Vollzugriff auf alle Einstellungen' if lang == 'de' else 'Full access to all settings' }}</small>
                    </div>
                    <div class="role-legend-item">
                        <span class="role-badge role-manager">
                            <i class="bi bi-gear-fill"></i>Manager
                        </span>
                        <small class="text-muted flex-grow-1">{{ 'Verwaltet Aufgaben & Projekte' if lang == 'de' else 'Manages tasks & projects' }}</small>
                    </div>
                    <div class="role-legend-item">
                        <span class="role-badge role-member">
                            <i class="bi bi-person-fill"></i>Member
                        </span>
                        <small class="text-muted flex-grow-1">{{ 'Bearbeitet eigene Aufgaben' if lang == 'de' else 'Edits own tasks' }}</small>
                    </div>
                    <div class="role-legend-item mb-0">
                        <span class="role-badge role-viewer">
                            <i class="bi bi-eye-fill"></i>Viewer
                        </span>
                        <small class="text-muted flex-grow-1">{{ 'Nur Lesezugriff' if lang == 'de' else 'Read-only access' }}</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Member List -->
        <div class="col-lg-8">
            <div class="member-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-people-fill me-2 text-primary"></i>
                        {{ 'Aktuelle Mitglieder' if lang == 'de' else 'Current Members' }}
                        <span class="badge bg-primary ms-2">{{ memberships|length }}</span>
                    </div>
                </div>
                
                {% if memberships %}
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0 ps-4">{{ 'Benutzer' if lang == 'de' else 'User' }}</th>
                                    <th class="border-0">{{ 'E-Mail' if lang == 'de' else 'Email' }}</th>
                                    <th class="border-0">{{ 'Rolle' if lang == 'de' else 'Role' }}</th>
                                    <th class="border-0">{{ 'Mitglied seit' if lang == 'de' else 'Member since' }}</th>
                                    <th class="border-0 text-end pe-4">{{ 'Aktionen' if lang == 'de' else 'Actions' }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for m in memberships %}
                                <tr class="member-row">
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="member-avatar me-3" style="background: linear-gradient(135deg, 
                                                {% if m.role == 'admin' %}#dc3545, #c82333
                                                {% elif m.role == 'manager' %}#ffc107, #e0a800
                                                {% elif m.role == 'member' %}#0076A8, #005a82
                                                {% else %}#6c757d, #5a6268{% endif %});">
                                                {{ m.user.name[0]|upper if m.user.name else '?' }}
                                            </div>
                                            <div>
                                                <div class="fw-semibold">{{ m.user.name }}</div>
                                                <div class="d-flex gap-1">
                                                    {% if m.user.is_superadmin %}
                                                    <span class="badge bg-dark" style="font-size: 0.65rem;">Super-Admin</span>
                                                    {% endif %}
                                                    {% if not m.user.is_active %}
                                                    <span class="badge bg-secondary" style="font-size: 0.65rem;">{{ 'Inaktiv' if lang == 'de' else 'Inactive' }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-muted">{{ m.user.email }}</td>
                                    <td>
                                        <form action="{{ url_for('admin_tenants.tenant_update_member', tenant_id=tenant.id, user_id=m.user.id) }}" 
                                              method="POST" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <select name="role" class="form-select form-select-sm" 
                                                    style="width: auto; border-radius: 0.5rem;" 
                                                    onchange="this.form.submit()">
                                                <option value="viewer" {% if m.role == 'viewer' %}selected{% endif %}>üîç Viewer</option>
                                                <option value="member" {% if m.role == 'member' %}selected{% endif %}>üë§ Member</option>
                                                <option value="manager" {% if m.role == 'manager' %}selected{% endif %}>‚öôÔ∏è Manager</option>
                                                <option value="admin" {% if m.role == 'admin' %}selected{% endif %}>üõ°Ô∏è Admin</option>
                                            </select>
                                        </form>
                                    </td>
                                    <td class="text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        {{ m.created_at.strftime('%d.%m.%Y') if m.created_at else '-' }}
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="action-buttons justify-content-end">
                                            <form action="{{ url_for('admin_tenants.tenant_remove_member', tenant_id=tenant.id, user_id=m.user.id) }}" 
                                                  method="POST" 
                                                  onsubmit="return confirm('{{ 'Benutzer wirklich entfernen? Der Zugriff auf diesen Mandanten wird entzogen.' if lang == 'de' else 'Really remove user? Access to this tenant will be revoked.' }}');">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                        style="border-radius: 0.5rem;"
                                                        title="{{ 'Entfernen' if lang == 'de' else 'Remove' }}">
                                                    <i class="bi bi-person-x"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="card-body text-center py-5">
                    <i class="bi bi-people display-1 text-muted opacity-50 mb-3 d-block"></i>
                    <h5 class="text-muted">{{ 'Keine Mitglieder' if lang == 'de' else 'No members' }}</h5>
                    <p class="text-muted mb-0">
                        {{ 'F√ºgen Sie Benutzer hinzu, um ihnen Zugriff auf diesen Mandanten zu gew√§hren.' if lang == 'de' else 'Add users to grant them access to this tenant.' }}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
